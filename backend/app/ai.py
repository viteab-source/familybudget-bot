import json
import os
from datetime import datetime

import httpx
from dotenv import load_dotenv

load_dotenv()

YANDEX_API_KEY = os.getenv("YANDEX_API_KEY")
YANDEX_FOLDER_ID = os.getenv("YANDEX_FOLDER_ID")


def get_model_uri() -> str:
    """URI модели YandexGPT."""
    if not YANDEX_FOLDER_ID:
        raise RuntimeError("YANDEX_FOLDER_ID не задан. Проверь .env")
    return f"gpt://{YANDEX_FOLDER_ID}/yandexgpt-lite/latest"


def parse_text_to_transaction(text: str) -> dict:
    """
    Вызывает YandexGPT, чтобы из произвольного текста сделать JSON транзакции.
    
    Возвращает dict с ключами:
    - amount (float)
    - currency (str)
    - category (str | None) - основная категория
    - candidate_categories (list[str]) - топ-3 подходящих категории
    - description (str | None)
    - date (str в формате YYYY-MM-DD, если удалось определить)
    """

    if not YANDEX_API_KEY or not YANDEX_FOLDER_ID:
        raise RuntimeError("YANDEX_API_KEY или YANDEX_FOLDER_ID не заданы. Проверь .env")

    url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"

    # Текущая дата и год — подставляем в промпт
    today = datetime.utcnow().date()
    today_str = today.strftime("%Y-%m-%d")
    current_year = today.year

    system_prompt = f"""
Ты помощник по семейным финансам.

Твоя задача — из короткого человеческого текста про покупку, расход или доход
сделать СТРОГО один JSON-объект с полями:

{{
  "amount": число (в рублях или евро, без текста),
  "currency": "RUB" или "EUR",
  "category": "строка основной категории на русском",
  "candidate_categories": ["категория1", "категория2", "категория3"],
  "description": "краткое описание магазина/расхода/дохода",
  "date": "YYYY-MM-DD"
}}

ТЕКУЩАЯ ДАТА: {today_str}
ТЕКУЩИЙ ГОД: {current_year}

=====================
1. СУММА (amount)
=====================

Сумма может быть:
- написана ЦИФРАМИ: "2435", "2 435₽", "1 200 руб", "50€"
- написана СЛОВАМИ по-русски: "две тысячи четыреста тридцать пять рублей"

Твоя задача — ВСЕГДА перевести сумму в число (float), например:
- "2435" → 2435.0
- "2 435₽" → 2435.0
- "две тысячи четыреста тридцать пять рублей" → 2435.0

Если текст явно описывает доход (зарплата, перевод, возврат денег) — всё равно amount = итоговая сумма (положительная).

=====================
2. ВАЛЮТА (currency)
=====================

Определяй по тексту:
- символы "₽", "руб", "RUB" → "RUB"
- символы "€", "EUR" → "EUR"
Если валюта не указана — по умолчанию "RUB".

=====================
3. ДАТА (date)
=====================

Формат: строго "YYYY-MM-DD".

Используй:
- слова "сегодня" → текущая дата ({today_str})
- "вчера" → текущая дата минус 1 день
- "позавчера" → минус 2 дня
- "на прошлой неделе", "в прошлую пятницу" — оценивай дату примерно в пределах текущего/предыдущего месяца.
- если указана явная дата (например, "25 ноября", "10.09", "01.02.2024") — используй её,
  аккуратно подставляя год. Если год не указан — используй {current_year}.

Если дату понять нельзя — используй текущую дату ({today_str}).

=====================
4. КАТЕГОРИЯ (category) + КАНДИДАТЫ (candidate_categories)
=====================

СПИСОК ДОСТУПНЫХ КАТЕГОРИЙ:

- "Продукты"
- "Кафе и рестораны"
- "Дети"
- "Игрушки"
- "Животные"
- "Корма для животных"
- "Химия и бытовое"
- "Личная гигиена"
- "Одежда и обувь"
- "Дом и ремонт"
- "Техника и электроника"
- "Транспорт"
- "Такси"
- "Авто"
- "Алкоголь"
- "Кофе и чай"
- "Медицина и аптека"
- "Подписки и сервисы"
- "Развлечения"
- "Подарки"
- "Образование"
- "Коммуналка"
- "Аренда и ипотека"
- "Налоги и штрафы"
- "Связь и интернет"
- "Доход: зарплата"
- "Доход: бизнес"
- "Доход: перевод"
- "Доход: проценты"
- "Другое"

ТЫ ДОЛЖЕН:
1. Выбрать ОДНУ основную категорию → поле "category"
2. Предложить ТОП-3 подходящих категории → поле "candidate_categories" (массив из 3 строк)

ВАЖНО:
- Первая категория в candidate_categories ДОЛЖНА совпадать с category
- Следующие 2 категории — альтернативные варианты, которые тоже могут подойти

Пример для "Магнит 500":
{{
  "category": "Продукты",
  "candidate_categories": ["Продукты", "Химия и бытовое", "Другое"]
}}

Пример для "Кб пиво 690":
{{
  "category": "Алкоголь",
  "candidate_categories": ["Алкоголь", "Продукты", "Другое"]
}}

ОБЩИЕ ПРАВИЛА:
- Если текст явно про ребёнка: "игрушка для сына", "садик", "школа", "кружок" → чаще всего "Дети" или "Игрушки".
- "корм для кота/кошки/собаки/питомца" → "Корма для животных" или "Животные".
- "шампунь", "гель для душа", "зубная паста", "косметика", "дезодорант" → "Личная гигиена".
- "стиральный порошок", "чистящее средство", "уборка", "средство для посуды" → "Химия и бытовое".
- "вино", "водка", "пиво", "коньяк" → "Алкоголь".
- "кофе", "зерно", "капсулы", "чай" как отдельная покупка → "Кофе и чай".
- "такси", "Яндекс.Такси", "Uber", "Citymobil" → "Такси".
- "заправка", "бензин", "дизель" → "Авто" или "Транспорт".
- "подписка", "Netflix", "Spotify", "Yandex Plus", "кинопоиск" → "Подписки и сервисы".
- "аренда", "ипотека", "квартира", "съём жилья" → "Аренда и ипотека".
- "коммуналка", "ЖКХ", "свет", "газ", "вода" → "Коммуналка".
- явный текст про зарплату → "Доход: зарплата".
- явный перевод от людей или между счетами → "Доход: перевод" или соответствующая доходная категория.

МАГАЗИНЫ И МАРКЕТПЛЕЙСЫ (примерные правила для расходов):
- Магазины "Пятёрочка", "Дикси", "Перекрёсток", "Магнит", "Лента", "Ашан", "Верный", "Окей":
  обычно основная категория "Продукты", но учитывай текст:
  - если видно, что речь про игрушки → "Игрушки" / "Дети";
  - если про химию → "Химия и бытовое";
  - если про корм → "Корма для животных".
- Маркетплейсы "Wildberries", "Ozon", "Яндекс Маркет", "AliExpress":
  смотри на сам товар: "термобраш", "шампунь", "игрушка", "корм", "одежда" и т.д.
- Fix Price и подобные — по смыслу товара (продукты, химия, игрушки и т.п.).

=====================
5. ОПИСАНИЕ (description)
=====================

Кратко, но полезно:
- название магазина ("Пятёрочка", "Дикси", "Wildberries");
- или "садик", "школа", "аренда квартиры", "подписка Netflix" и т.п.
- можно добавить 1–2 слова про суть покупки.

=====================
6. РЕЗУЛЬТАТ
=====================

- ВСЕГДА возвращай ТОЛЬКО ОДИН JSON-объект.
- НИКАКОГО текста до или после JSON.
- amount — число (без строк).
- currency — строка "RUB" или "EUR".
- category — одна строка из списка выше (или "Другое").
- candidate_categories — МАССИВ из ровно 3 строк (первая = category).
- description — строка.
- date — строка в формате "YYYY-MM-DD".
"""

    payload = {
        "modelUri": get_model_uri(),
        "completionOptions": {
            "stream": False,
            "temperature": 0.1,
            "maxTokens": 400,
        },
        "messages": [
            {"role": "system", "text": system_prompt},
            {"role": "user", "text": text},
        ],
    }

    headers = {
        "Authorization": f"Api-Key {YANDEX_API_KEY}",
        "x-folder-id": YANDEX_FOLDER_ID,
        "Content-Type": "application/json",
    }

    with httpx.Client(timeout=20.0) as client:
        resp = client.post(url, headers=headers, json=payload)
        resp.raise_for_status()
        data = resp.json()

    # YandexGPT обычно возвращает текст в поле result.alternatives[0].message.text
    raw_text = data["result"]["alternatives"][0]["message"]["text"]

    try:
        parsed = json.loads(raw_text)
    except json.JSONDecodeError:
        # На всякий случай вычищаем возможные ```
        cleaned = raw_text.strip().strip("```").strip()
        if cleaned.startswith("json"):
            cleaned = cleaned[4:].strip()
        parsed = json.loads(cleaned)

    # Если GPT не вернул candidate_categories (обратная совместимость)
    if "candidate_categories" not in parsed:
        cat = parsed.get("category", "Другое")
        parsed["candidate_categories"] = [cat, "Другое"]
    
    # Убедимся что первая категория = основной
    if parsed.get("candidate_categories") and parsed.get("category"):
        if parsed["candidate_categories"][0] != parsed["category"]:
            parsed["candidate_categories"][0] = parsed["category"]

    return parsed
